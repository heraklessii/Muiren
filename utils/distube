const Discord = require("discord.js")
const { EmbedBuilder, ButtonBuilder, ActionRowBuilder, ButtonStyle } = require('discord.js');
const { JsonDatabase } = require("wio.db");
const db = new JsonDatabase({
  databasePath: "./Depo/muzik.json"
});

module.exports = async (client) => {

  client.distube.on('playSong', async (queue) => {

    client.UpdateQueueMsg(queue)

    const data = db.get(`mÃ¼zikSunucu-${queue.id}.setupAyarlar`);

    if (!data || data.sistemDurumu === false || data.sistemDurumu === null) {

      const embeded = new EmbedBuilder()
        .setAuthor({ name: `ÅžarkÄ± oynatÄ±lÄ±yor...`, iconURL: 'https://cdn.discordapp.com/emojis/741605543046807626.gif' })
        .setImage(queue.songs[0].thumbnail)
        .setColor(client.color)
        .setDescription(`**[${queue.songs[0].name}](${queue.songs[0].url})**`)
        .addFields({ name: `Oynatan KiÅŸi:`, value: `${queue.songs[0].user}`, inline: true })
        .addFields({ name: `Mevcut Ses:`, value: `**%${queue.volume}**`, inline: true })
        .addFields({ name: `Filtreler:`, value: `**${queue.filters.names.join(", ") || "KapalÄ±"}**`, inline: true })
        .addFields({ name: `Oto Oynatma:`, value: `**${queue.autoplay ? "AÃ§Ä±k" : "KapalÄ±"}**`, inline: true })
        .addFields({ name: `Toplam SÃ¼re:`, value: `${queue.songs[0].formattedDuration}`, inline: true })
        .addFields({ name: `Mevcut SÃ¼re: \`[0:00 / ${queue.songs[0].formattedDuration}]\``, value: `\`\`\`ðŸ”´ | ðŸŽ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\`\`\``, inline: false })
        .setTimestamp()

      const row = new ActionRowBuilder()
        .addComponents(
          new ButtonBuilder()
            .setCustomId("pause")
            .setEmoji("â¯")
            .setStyle(ButtonStyle.Success)
        )
        .addComponents(
          new ButtonBuilder()
            .setCustomId("previous")
            .setEmoji("â¬…")
            .setStyle(ButtonStyle.Primary)
        )
        .addComponents(
          new ButtonBuilder()
            .setCustomId("stop")
            .setEmoji("âœ–")
            .setStyle(ButtonStyle.Danger)
        )
        .addComponents(
          new ButtonBuilder()
            .setCustomId("skip")
            .setEmoji("âž¡")
            .setStyle(ButtonStyle.Primary)
        )
        .addComponents(
          new ButtonBuilder()
            .setCustomId("loop")
            .setEmoji("ðŸ”„")
            .setStyle(ButtonStyle.Success)
        )

      const nowplay = await queue.textChannel.send({ embeds: [embeded], components: [row] })

      const filter = (interaction) => {

        if (interaction.guild.members.me.voice.channel && interaction.guild.members.me.voice.channelId === interaction.member.voice.channelId) return true;

        else {

          interaction.reply({ content: ":x: | ButonlarÄ± kullanabilmek iÃ§in benimle aynÄ± ses kanalÄ±nda olmalÄ±sÄ±n.", ephemeral: true })

        }

      };

      const collector = nowplay.createMessageComponentCollector({ filter, time: queue.songs[0].duration * 1000 });

      collector.on('collect', async (interaction) => {

        const id = interaction.customId;

        const queue = client.distube.getQueue(interaction.guild.id);

        if (interaction.user.id != queue.songs[0].user) return interaction.reply({
          content: `:x: | ${interaction.user}, oynatÄ±lan ÅŸarkÄ±yÄ± siz eklemediÄŸiniz iÃ§in butonlarÄ± kullanamazsÄ±nÄ±z.`,
          ephemeral: true,
        })

        if (id === "pause") {

          if (!queue) {

            collector.stop();

          }

          if (queue.paused) {

            await client.distube.resume(interaction.guild.id);

            const embed = new EmbedBuilder()
              .setColor(client.color)
              .setDescription(`â¯ | ÅžarkÄ± devam ettiriliyor.`);

            interaction.reply({ embeds: [embed], ephemeral: true })

          } else {

            await client.distube.pause(interaction.guild.id);

            const embed = new EmbedBuilder()
              .setColor(client.color)
              .setDescription(`â¯ | ÅžarkÄ± durduruluyor.`);

            interaction.reply({ embeds: [embed], ephemeral: true })

          }

        } else if (id === "skip") {

          if (!queue) {

            collector.stop();

          }

          if (queue.songs.length === 1 && queue.autoplay === false) {

            const embed = new EmbedBuilder()
              .setColor(client.color)
              .setDescription(":x: | SÄ±rada atlanacak hiÃ§ ÅŸarkÄ± yok.")

            interaction.reply({ embeds: [embed], ephemeral: true })

          } else {

            await client.distube.skip(interaction)

            const embed = new EmbedBuilder()
              .setColor(client.color)
              .setDescription("â­ | ÅžarkÄ± baÅŸarÄ±yla atlandÄ±.")

            nowplay.delete();

            collector.stop();

            interaction.reply({ embeds: [embed], ephemeral: true })

          }

        } else if (id === "stop") {

          if (!queue) {

            collector.stop();

          }

          await client.distube.stop(interaction.guild.id);

          const embed = new EmbedBuilder()
            .setDescription(`ðŸš« | ÅžarkÄ± oynatmayÄ± bitirdim.`)
            .setColor(client.color);

          nowplay.delete();
          collector.stop();

          interaction.reply({ embeds: [embed], ephemeral: true })

        } else if (id === "loop") {

          if (!queue) {

            collector.stop();

          }

          if (queue.repeatMode === 0) {

            client.distube.setRepeatMode(interaction.guild.id, 1);

            const embed = new EmbedBuilder()
              .setColor(client.color)
              .setDescription(`ðŸ” | ÅžarkÄ± tekrar modu aktif edildi.`)

            interaction.reply({ embeds: [embed], ephemeral: true })

          } else {

            client.distube.setRepeatMode(interaction.guild.id, 0);

            const embed = new EmbedBuilder()
              .setColor(client.color)
              .setDescription(`ðŸ” | ÅžarkÄ± tekrar modu kapatÄ±ldÄ±.`)

            interaction.reply({ embeds: [embed], ephemeral: true })

          }

        } else if (id === "previous") {

          if (!queue) {

            collector.stop();

          }

          if (queue.previousSongs.length == 0) {

            const embed = new EmbedBuilder()
              .setColor(client.color)
              .setDescription(":x: | OynatÄ±lacak eski bir ÅŸarkÄ± bulunamadÄ±!")

            interaction.reply({ embeds: [embed], ephemeral: true })

          } else {

            await client.distube.previous(interaction)

            const embed = new EmbedBuilder()
              .setColor(client.color)
              .setDescription("â® | Eski ÅŸarkÄ± oynatÄ±lÄ±yor.")

            nowplay.delete();

            collector.stop();

            interaction.reply({ embeds: [embed], ephemeral: true })

          }
        }

      });

      collector.on('end', async (collected, reason) => {

        if (reason === "time") {

          nowplay.delete();

        }

      });

    }

    else if (data && data.sistemDurumu === true) return;

  })

  client.distube.on('addSong', (queue, song) => {

    const data = db.get(`mÃ¼zikSunucu-${queue.id}.setupAyarlar`);

    if (!data || data.sistemDurumu === false || data.sistemDurumu === null) {

      const embed = new EmbedBuilder()

        .setDescription(`${client.emotes.success} | **[${song.name}](${song.url})** \`${song.formattedDuration}\` â€¢ ${song.user}`)
        .setColor(client.green)

      return queue.textChannel.send({ embeds: [embed] }).then((sent) => {
        setTimeout(() => {
          sent.delete();
        }, 5000);
      });

    }

    else if (data.sistemDurumu === true) return;

  })

  client.distube.on('addList', (queue, playlist) => {

    const data = db.get(`mÃ¼zikSunucu-${queue.id}.setupAyarlar`);

    if (!data || data.sistemDurumu === false || data.sistemDurumu === null) {

      const embed = new EmbedBuilder()
        .setDescription(`${client.emotes.success} | **[${playlist.name}](${playlist.url})** \`${queue.formattedDuration}\` (${playlist.songs.length} ÅŸarkÄ±) â€¢ ${playlist.user}`)
        .setColor(client.green)

      return queue.textChannel.send({ embeds: [embed] }).then((sent) => {
        setTimeout(() => {
          sent.delete();
        }, 5000);
      });

    }

    else if (data.sistemDurumu === true) return;

  })

  client.distube.on('initQueue', (queue) => {

    return queue.volume = 100;

  })

  client.distube.on('empty', (queue) => {

    client.UpdateMusic(queue);

    const embed = new EmbedBuilder()
      .setColor(client.red)
      .setDescription(`:musical_note: | Kanalda tek baÅŸÄ±ma kaldÄ±m! AyrÄ±lÄ±yorum.`)

    return queue.textChannel.send({ embeds: [embed] }).then((sent) => {
      setTimeout(() => {
        sent.delete();
      }, 5000);
    });

  })

  client.distube.on('error', (e) => {

    const channel = process.env.LOGS
    const Channel = client.channels.cache.get(channel)

    const embed = new EmbedBuilder()
      .setDescription(`âŒ | Bir hata meydana geldi: ${e.toString().slice(0, 1900)}`)
      .setColor(client.red)

    return Channel.send({ embeds: [embed] })

  })

  client.distube.on('finish', (queue) => {

    const data = db.get(`mÃ¼zikSunucu-${queue.id}.setupAyarlar`);

    if (!data || data.sistemDurumu === false || data.sistemDurumu === null) {

      client.UpdateMusic(queue)
      client.distube.voices.leave(queue.textChannel.guild);

      const embed = new Discord.EmbedBuilder()
        .setDescription(`:musical_note: | Listedeki bÃ¼tÃ¼n ÅŸarkÄ±larÄ± oynatmayÄ± bitirdim.`)
        .setColor(client.green)

      return queue.textChannel.send({ embeds: [embed] }).then((sent) => {
        setTimeout(() => {
          sent.delete();
        }, 5000);
      });

    }

    else if (data && data.sistemDurumu === true) {

      client.UpdateMusic(queue)

      const embed = new Discord.EmbedBuilder()
        .setDescription(`:musical_note: | Listedeki bÃ¼tÃ¼n ÅŸarkÄ±larÄ± oynatmayÄ± bitirdim.`)
        .setColor(client.green)

      return queue.textChannel.send({ embeds: [embed] }).then((sent) => {
        setTimeout(() => {
          sent.delete();
        }, 5000);
      });


    }

  })

  client.distube.on('searchNoResult', (message, query) => {

    const embed = new EmbedBuilder()
      .setDescription(`âŒ | \`${query}\` ile eÅŸleÅŸen sonuÃ§ bulamadÄ±m...`)
      .setColor(client.red)

    return message.channel.send({ embeds: [embed] }).then((sent) => {
      setTimeout(() => {
        sent.delete();
      }, 5000);
    });

  })

  client.distube.on('noRelated', (queue) => {

    const embed = new EmbedBuilder()
      .setDescription(`âŒ | OynatÄ±lacak ÅŸarkÄ± bulamadÄ±m!`)
      .setColor(client.red)

    return queue.textChannel.send({ embeds: [embed] }).then((sent) => {
      setTimeout(() => {
        sent.delete();
      }, 5000);
    });

  })

  client.UpdateQueueMsg = async function (queue) {

    const MusicButtons2 = new Discord.ActionRowBuilder()
      .addComponents([
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("spause")
          .setEmoji("â¯"),
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("sprevious")
          .setEmoji("â¬…"),
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("sstop")
          .setEmoji("â¹"),
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("sskip")
          .setEmoji("âž¡"),
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("sloop")
          .setEmoji("ðŸ”„"),
      ]);

    const CheckDB = db.fetch(`mÃ¼zikSunucu-${queue.id}`);
    if (!CheckDB) return;

    const data = db.get(`mÃ¼zikSunucu-${queue.id}.setupAyarlar`);
    if (!data || data.sistemDurumu === false || data.sistemDurumu === null) return;

    const channel = client.channels.cache.get(data.kanal);
    if (!channel) return;

    const playMsg = await channel.messages.fetch(data.mesaj, { cache: false, force: true });
    if (!playMsg) return;

    const songStrings = [];
    const queuedSongs = queue.songs.map((song, i) => `*\`${i + 1} â€¢ ${song.name} â€¢ [${song.formattedDuration}]\`* â€¢ \`${song.user.tag}\``);

    songStrings.push(...queuedSongs);
    const Str = songStrings.slice(0, 10).join('\n');

    const cSong = queue.songs[0];
    const played = queue.playing ? `OynatÄ±lÄ±yor...` : `Durduruluyor...`;

    const embed = new EmbedBuilder()
      .setAuthor({ name: `${played}`, iconURL: "https://cdn.discordapp.com/emojis/741605543046807626.gif" })
      .setDescription(`[${cSong.name}](${cSong.url}) \`[${cSong.formattedDuration}]\` â€¢ ${cSong.user}`)
      .setColor(client.color)
      .setImage(`https://img.youtube.com/vi/${cSong.id}/sddefault.jpg`)
      .setFooter({ text: `${queue.songs.length} â€¢ MÃ¼zik Kuyrukta | Ses â€¢ %${queue.volume} | ${queue.formattedDuration} â€¢ Toplam SÃ¼re` })

    return playMsg.edit({
      content: `**__ÅžarkÄ± Listesi:__**\n${Str == '' ? `OynatÄ±lan ÅŸarkÄ±lar burada yer alacak.` : '\n' + Str}`,
      embeds: [embed],
      components: [MusicButtons2]
    }).catch((e) => { });
  };

  client.UpdateMusic = async function (queue) {

    const MusicButtons = new Discord.ActionRowBuilder()
      .addComponents([
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("spause")
          .setEmoji("â¯")
          .setDisabled(true),
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("sprevious")
          .setEmoji("â¬…")
          .setDisabled(true),
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("sstop")
          .setEmoji("â¹")
          .setDisabled(true),
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("sskip")
          .setEmoji("âž¡")
          .setDisabled(true),
        new Discord.ButtonBuilder()
          .setStyle(ButtonStyle.Secondary)
          .setCustomId("sloop")
          .setEmoji("ðŸ”„")
          .setDisabled(true),
      ]);

    const CheckDB = db.fetch(`mÃ¼zikSunucu-${queue.id}`);
    if (!CheckDB) return;

    const data = await db.get(`mÃ¼zikSunucu-${queue.id}.setupAyarlar`);
    if (!data || data.sistemDurumu === false || data.sistemDurumu === null) return;

    const channel = client.channels.cache.get(data.kanal);
    if (!channel) return;

    const playMsg = await channel.messages.fetch(data.mesaj, { cache: false, force: true });
    if (!playMsg) return;

    const queueMsg = `**__ÅžarkÄ± Listesi:__**\nOynatÄ±lan ÅŸarkÄ±lar burada yer alacak.`;
    const playEmbed = new EmbedBuilder()
      .setColor(client.color)
      .setAuthor({ name: `HenÃ¼z bu sunucuda ÅŸarkÄ± oynatÄ±lmÄ±yor.` })
      .setImage(`https://images3.alphacoders.com/110/1105694.jpg`)
      .setDescription(`>>> [Davet](https://discord.com/api/oauth2/authorize?client_id=${client.user.id}&permissions=2184310032&scope=bot%20applications.commands) | [Destek](https://discord.gg/muiren) | [Ä°nternet Sitesi](https://muirenanime.net) | [Panel](http://panel.muirenanime.net)`)
      .setFooter({ text: `Ashii MÃ¼zik Sistemi` });

    return playMsg.edit({
      content: `${queueMsg}`,
      embeds: [playEmbed],
      components: [MusicButtons]
    }).catch((e) => { });

  };

}

